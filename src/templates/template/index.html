



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://trundle.github.io/pony-templates/src/templates/template/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-ponylang-0.2.8">
    
    
      
        <title>Template - templates</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.b80b25f7.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.0b5df86e.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://trundle.github.io/pony-templates/" title="templates" class="md-header-nav__button md-logo">
          
            <img src="../../../assets/images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                templates
              </span>
              <span class="md-header-nav__topic">
                Template
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../assets/images/logo.png" width="48" height="48">
      
    </span>
    templates
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="templates" class="md-nav__link">
      templates
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      package templates
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        package templates
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../templates--index/" title="Package" class="md-nav__link">
      Package
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../templates-TemplateValue/" title="class TemplateValue" class="md-nav__link">
      class TemplateValue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../templates-TemplateValues/" title="class TemplateValues" class="md-nav__link">
      class TemplateValues
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../templates-TemplateContext/" title="class TemplateContext" class="md-nav__link">
      class TemplateContext
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../templates-Template/" title="class Template" class="md-nav__link">
      class Template
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Template</h1>
                
                <pre><code class="language-pony-full-source">&quot;&quot;&quot;
A simple text-based template engine.
&quot;&quot;&quot;

use &quot;collections&quot;
use &quot;files&quot;
use &quot;regex&quot;
use &quot;valbytes&quot;


primitive _Literal

class _Call
  let f: {(String): String} val
  let arg: _PropNode

  new box create(f': {(String): String} val, arg': _PropNode) =&gt;
    f = f'
    arg = arg'

class _If
  let value: _PropNode
  let body: Array[_Part] box

  new box create(value': _PropNode, body': Array[_Part] box) =&gt;
    value = value'
    body = body'

class _IfNotEmpty
  let value: _PropNode
  let body: Array[_Part] box

  new box create(value': _PropNode, body': Array[_Part] box) =&gt;
    value = value'
    body = body'

class _Loop
  let target: String
  let source: _PropNode
  let body: Array[_Part] box

  new box create(target': String, source': _PropNode, body': Array[_Part] box) =&gt;
    target = target'
    source = source'
    body = body'

type _Part is ((_Literal, String) | _Call box | _PropNode | _If box | _IfNotEmpty box | _Loop box)


class box TemplateValue
  &quot;&quot;&quot;
  A value that can be used in a template. Either a single value or a
  sequence of values.
  &quot;&quot;&quot;
  let _value: (String | None)
  let _values: Seq[TemplateValue] box
  let _properties: Map[String, TemplateValue] box

  new box create(
    value: (String | Seq[TemplateValue] box),
    properties: Map[String, TemplateValue] box = Map[String, TemplateValue]
  ) =&gt;
    _value = match value
    | let s: String =&gt; s
    else None
    end
    _values = match value
    | let seq: Seq[TemplateValue] box =&gt; seq
    else []
    end
    _properties = properties

  fun apply(name: String): TemplateValue? =&gt; _properties(name)?

  fun string(): String? =&gt; _value as String

  fun values(): Iterator[TemplateValue] =&gt; _values.values()


class TemplateValues
  let _parent: (TemplateValues box | None)
  let _values: Map[String, TemplateValue]

  new _create(
    parent: TemplateValues box,
    values: Map[String, TemplateValue]
  ) =&gt;
    _parent = parent
    _values = values

  new create() =&gt;
    _parent = None
    _values = Map[String, TemplateValue]

  fun box apply(name: String): TemplateValue? =&gt;
    try _values(name)?
    else
      match _parent
      | let parent: TemplateValues box =&gt; parent(name)?
      | None =&gt; error
      end
    end


  fun box _lookup(prop: _PropNode): TemplateValue? =&gt;
    var value = this(prop.name)?
    for name in prop.props.values() do
      value = value(name)?
    end

    value

  fun ref update(name: String, value: (String | TemplateValue)) =&gt;
    _values(name) = match value
    | let string: String =&gt; TemplateValue(string)
    | let template_value: TemplateValue =&gt; template_value
    end

  fun box _override(name: String, value: TemplateValue): TemplateValues =&gt;
    let values = Map[String, TemplateValue]
    values(name) = value
    TemplateValues._create(this, values)


class TemplateContext
  let functions: Map[String, {(String): String}] box

  new val create(
    functions': Map[String, {(String): String}] val = recover Map[String, {(String): String}] end
  ) =&gt;
    functions = functions'


class val Template
  let _parts: Array[_Part] box

  new val parse(source: String, ctx: TemplateContext val = TemplateContext())? =&gt;
    _parts = _parse(source, ctx)?

  new val from_file(path: FilePath, ctx: TemplateContext val = TemplateContext())? =&gt;
    let chunk_size: USize = 1024 * 1024 * 1
    match OpenFile(path)
    | let file: File =&gt;
      var data = ByteArrays()
      while file.errno() is FileOK do
        data = data + file.read(chunk_size)
      end
      _parts = _parse(data.string(), ctx)?
    else error
    end

  fun tag _parse(source: String, ctx: TemplateContext val): Array[_Part] box? =&gt;
    var parts: Array[_Part] = []
    var current_parts = parts
    var open: Array[((_IfNode | _IfNotEmptyNode | _LoopNode), Array[_Part])] = []
    var prev_end: USize = 0
    for m in Regex(&quot;\\{\\{(.+?)\\}\\}&quot;)?.matches(source) do
      if m.start_pos() != prev_end then
        let literal = source.substring(prev_end.isize(), m.start_pos().isize())
        current_parts.push((_Literal, consume literal))
      end

      match _StmtParser.parse(m(1)?)?
      | _EndNode =&gt; current_parts = _parse_end(open, parts)?
      | let prop: _PropNode =&gt; current_parts.push(prop)
      | let call: _CallNode =&gt;
        current_parts.push(_Call(ctx.functions(call.name)?, call.arg))
      | let if': _IfNode =&gt;
        current_parts = Array[_Part]
        open.push((if', current_parts))
      | let ifnotempty: _IfNotEmptyNode =&gt;
        current_parts = Array[_Part]
        open.push((ifnotempty, current_parts))
      | let loop: _LoopNode =&gt;
        current_parts = Array[_Part]
        open.push((loop, current_parts))
      end

      prev_end = m.end_pos() + 1
    end

    if prev_end &lt; source.size() then
      parts.push((_Literal, source.substring(prev_end.isize())))
    end

    if open.size() &gt; 0 then error end

    consume parts

  fun tag _parse_end(
    open: Array[((_IfNode | _IfNotEmptyNode | _LoopNode), Array[_Part])],
    parts: Array[_Part]
  ): Array[_Part]? =&gt;
    (let stmt, let body) = open.pop()?

    let next_current =
      if open.size() == 0 then parts
      else open(open.size() - 1)?._2
      end

    match stmt
    | let if': _IfNode =&gt;
      next_current.push(_If(if'.value, body))
    | let ifnotempty: _IfNotEmptyNode =&gt;
      next_current.push(_IfNotEmpty(ifnotempty.value, body))
    | let loop: _LoopNode =&gt;
      next_current.push(_Loop(loop.target, loop.source, body))
    end

    next_current

  fun render(values: TemplateValues box): String? =&gt;
    &quot;&quot;&quot;
    Fills in the given values into template.
    &quot;&quot;&quot;
    _render_parts(_parts, values)?

  fun tag _render_parts(parts: Array[_Part] box, values: TemplateValues box): String? =&gt;
    var result = ByteArrays()
    for part in parts.values() do
      match part
      | (_Literal, let value: String) =&gt; result = result + value
      | let call: _Call box =&gt;
        let arg = values._lookup(call.arg)?
        result = result + call.f(arg.string()?)
      | let prop: _PropNode =&gt;
        // XXX make this an error instead
        let substitution = try values._lookup(prop)?.string()? else &quot;&quot; end
        result = result + substitution
      | let if': _If box =&gt;
        try
          values._lookup(if'.value)?
          result = result + _render_parts(if'.body, values)?
        end
      | let ifnotempty: _IfNotEmpty box =&gt;
        if values._lookup(ifnotempty.value)?.values().has_next() then
          result = result + _render_parts(ifnotempty.body, values)?
        end
      | let loop: _Loop box =&gt;
        for value in values._lookup(loop.source)?.values() do
          let body_values = values._override(loop.target, value)
          result = result + _render_parts(loop.body, body_values)?
        end
      end
    end
    result.string()

</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
    <script src="../../../assets/javascripts/application.cb37bb38.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>